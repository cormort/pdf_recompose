<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF é é¢é‡çµ„å·¥å…· (æœ€çµ‚ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        .sidebar {
            width: 320px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar h2 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #ecf0f1;
        }

        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #34495e;
        }

        .upload-area:hover {
            background: #3d566e;
            border-color: #5dade2;
        }

        .upload-area.drag-over {
            background: #3d566e;
            border-color: #5dade2;
            transform: scale(1.02);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-warning {
            background: #e67e22;
            color: white;
            width: 100%;
            padding: 10px;
            font-size: 14px;
            position: relative;
        }

        .btn-warning:hover {
            background: #d35400;
        }

        .btn-warning.confirm-mode {
            background: #c0392b;
        }

        .btn-warning.confirm-mode::after {
            content: ' (å†æ¬¡é»æ“Šç¢ºèª)';
            font-size: 11px;
        }

        .btn-success {
            background: #27ae60;
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 16px;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .main-content {
            flex: 1;
            display: flex;
            gap: 20px;
            padding: 20px;
            overflow: hidden;
        }

        .source-panel, .target-panel {
            flex: 1;
            background: #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .panel-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toggle-group {
            display: flex;
            gap: 5px;
        }

        .toggle-group button {
            padding: 5px 10px;
            border: 1px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .toggle-group button.active {
            background: #3498db;
            color: white;
        }

        .btn-panel-action {
            padding: 5px 15px;
            border: none;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-clear { background: #e74c3c; }
        .btn-clear:hover { background: #c0392b; }
        .btn-clear.confirm-mode { background: #c0392b; }

        .btn-edit { background: #9b59b6; }
        .btn-edit:hover { background: #8e44ad; }
        .btn-edit.active { background: #27ae60; }
        
        .btn-add-section { background: #16a085; }
        .btn-add-section:hover { background: #117a65; }

        .pdf-file {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .pdf-file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .pdf-file-name {
            font-weight: bold;
            color: #2c3e50;
            flex: 1;
        }

        .pages-grid {
            display: grid;
            gap: 10px;
            margin-top: 10px;
            transition: grid-template-columns 0.3s;
        }
        
        .source-panel.size-medium .pages-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
        .source-panel.size-small .pages-grid { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); }
        .source-panel.size-large .pages-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
        .source-panel.size-xlarge .pages-grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }


        .pages-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .page-list-item {
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .page-list-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .page-list-item.selected {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .page-list-item .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 3px 8px;
            cursor: pointer;
            display: none;
            font-size: 12px;
        }

        .page-list-item .delete-btn:hover {
            background: #c0392b;
        }

        .source-panel.edit-mode .page-list-item .delete-btn {
            display: block;
        }

        .source-panel.edit-mode .page-list-item {
            cursor: default;
        }

        .page-list-text {
            flex: 1;
            font-size: 14px;
            color: #2c3e50;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }

        .page-list-number {
            font-size: 12px;
            color: #7f8c8d;
            background: #ecf0f1;
            padding: 2px 8px;
            border-radius: 3px;
            white-space: nowrap;
        }

        .page-item {
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            padding: 5px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            position: relative;
        }

        .page-item:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .page-item.selected {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .page-item .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            z-index: 10;
        }

        .page-item .delete-btn:hover {
            background: #c0392b;
        }

        .source-panel.edit-mode .page-item .delete-btn {
            display: flex;
        }

        .source-panel.edit-mode .page-item {
            cursor: default;
        }

        .page-item canvas {
            width: 100%;
            display: block;
            border-radius: 3px;
        }

        .page-number {
            text-align: center;
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .selected-pages {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .selected-page-item {
            background: white;
            border: 2px solid #27ae60;
            border-radius: 5px;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            cursor: move;
        }

        .selected-page-item.dragging, .selected-divider-item.dragging {
            opacity: 0.5;
        }

        .selected-page-item canvas {
            width: 80px;
            height: auto;
            border-radius: 3px;
        }

        .selected-page-info {
            flex: 1;
            min-width: 0;
        }

        .selected-page-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            padding: 4px 0;
        }

        .selected-page-source {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .selected-divider-item {
            background: #d5f5e3;
            border: 2px dashed #27ae60;
            border-radius: 5px;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            cursor: move;
            text-align: center;
        }
        
        .selected-divider-title {
            flex: 1;
            font-weight: bold;
            color: #145a32;
        }

        .file-list {
            list-style: none;
        }

        .file-list-item {
            background: #34495e;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 5px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .empty-message {
            text-align: center;
            color: #95a5a6;
            padding: 40px;
            font-size: 14px;
        }

        input[type="file"] {
            display: none;
        }

        .drag-handle {
            cursor: move;
            color: #7f8c8d;
            font-size: 18px;
        }

        .page-actions {
            display: flex;
            gap: 5px;
        }

        .progress {
            display: none;
            background: #34495e;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            color: white;
            font-weight: bold;
        }

        .progress.active {
            display: block;
        }

        .progress.error {
            background: #e74c3c;
        }

        .progress.success {
            background: #27ae60;
        }

        .note {
            background: #34495e;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.5;
            color: #bdc3c7;
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-content h3 {
            color: #2c3e50;
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 10px;
        }

        #tocTextarea {
            width: 100%;
            height: 300px;
            font-size: 14px;
            line-height: 1.6;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>ğŸ“„ PDF é é¢é‡çµ„å·¥å…·</h2>
        
        <div class="upload-area" id="uploadArea">
            <p style="margin-bottom: 10px;">ğŸ“ æ‹–æ›³ PDF æª”æ¡ˆåˆ°é€™è£¡</p>
            <p style="font-size: 12px; color: #bdc3c7; margin-bottom: 15px;">æˆ–</p>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                é¸æ“‡æª”æ¡ˆ
            </button>
            <input type="file" id="fileInput" accept="application/pdf" multiple>
        </div>

        <div>
            <h2>å·²è¼‰å…¥æª”æ¡ˆ</h2>
            <ul class="file-list" id="fileList"></ul>
            <button class="btn btn-warning" id="clearFilesBtn" onclick="clearAllFiles()" style="margin-top: 10px;">
                ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æª”æ¡ˆ
            </button>
        </div>

        <div class="note">
            ğŸ’¡ æç¤ºï¼šç”Ÿæˆçš„ PDF æœƒä¿ç•™åŸå§‹æ–‡å­—ï¼Œå¯ä»¥æ­£å¸¸æœå°‹å’Œè¤‡è£½ã€‚ç›®éŒ„ä½¿ç”¨æ€æºé»‘é«”ä»¥æ”¯æ´ä¸­æ–‡é¡¯ç¤ºã€‚
        </div>

        <div class="progress" id="progress">
            <div>æ­£åœ¨ç”Ÿæˆ PDF...</div>
        </div>

        <button class="btn btn-success" id="generateBtn" onclick="generatePDF()">
            ç”Ÿæˆæ–°çš„ PDF
        </button>
    </div>

    <div class="main-content">
        <div class="source-panel" id="sourcePanel">
            <div class="panel-title">
                <span>ğŸ“‘ åŸå§‹ PDF é é¢</span>
                <div class="panel-controls">
                    <div class="toggle-group" id="size-toggle">
                        <button onclick="setThumbnailSize('small')">å°</button>
                        <button onclick="setThumbnailSize('medium')">ä¸­</button>
                        <button onclick="setThumbnailSize('large')">å¤§</button>
                        <button onclick="setThumbnailSize('xlarge')">è¶…å¤§</button>
                    </div>
                    <div class="toggle-group">
                        <button id="gridViewBtn" class="active" onclick="setViewMode('grid')">ç¸®åœ–</button>
                        <button id="listViewBtn" onclick="setViewMode('list')">æ¸…å–®</button>
                    </div>
                    <button id="editSourceBtn" class="btn-panel-action btn-edit" onclick="toggleSourceEditMode()">ğŸ—‘ï¸ åˆªé™¤é é¢</button>
                </div>
            </div>
            <div id="sourcePages"></div>
        </div>

        <div class="target-panel">
            <div class="panel-title">
                <span>ğŸ“‹ å·²é¸æ“‡çš„é é¢</span>
                <div class="panel-controls">
                    <button class="btn-panel-action btn-add-section" onclick="addSectionDivider()">â• æ–°å¢å°ç¯€</button>
                    <button class="btn-panel-action btn-edit" onclick="openTocEditor()">âœï¸ æ‰¹æ¬¡ç·¨è¼¯ç›®éŒ„</button>
                    <button id="clearSelectedBtn" class="btn-panel-action btn-clear" onclick="clearSelectedPages()">ğŸ—‘ï¸ æ¸…é™¤é¸å–</button>
                </div>
            </div>
            <div class="selected-pages" id="selectedPages"></div>
        </div>
    </div>

    <!-- TOC Edit Modal -->
    <div class="modal-overlay" id="tocModal">
        <div class="modal-content">
            <h3>æ‰¹æ¬¡ç·¨è¼¯ç›®éŒ„</h3>
            <p style="font-size: 13px; color: #7f8c8d;">è«‹åœ¨ä¸‹æ–¹ç·¨è¼¯ç›®éŒ„ï¼Œä¸€è¡Œä»£è¡¨ä¸€é ã€‚å®Œæˆå¾Œè«‹ç¢ºä¿ç¸½è¡Œæ•¸èˆ‡é¸æ“‡çš„é æ•¸ç›¸åŒã€‚</p>
            <textarea id="tocTextarea"></textarea>
            <div class="modal-actions">
                <button class="btn" onclick="closeTocEditor()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveToc()">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfFiles = [];
        let selectedPages = [];
        let draggedElement = null;
        let viewMode = 'grid';
        let thumbnailSize = 'medium';
        let lastSelectedIndex = null;
        let clearFilesConfirmMode = false;
        let clearSelectedConfirmMode = false;
        let isSourceEditMode = false;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const sourcePanel = document.getElementById('sourcePanel');
        const sourcePages = document.getElementById('sourcePages');
        const selectedPagesContainer = document.getElementById('selectedPages');
        const progress = document.getElementById('progress');
        const tocModal = document.getElementById('tocModal');
        const tocTextarea = document.getElementById('tocTextarea');

        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('drag-over'); });
        uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('drag-over'); });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
            handleFiles(files);
        });
        fileInput.addEventListener('change', (e) => { handleFiles(Array.from(e.target.files)); });

        async function handleFiles(files) {
            if (files.length === 0) return;
            
            progress.textContent = `â³ æ­£åœ¨è¼‰å…¥ ${files.length} å€‹æª”æ¡ˆ...`;
            progress.classList.remove('success', 'error');
            progress.classList.add('active');

            for (const file of files) {
                const fileData = { name: file.name, file: file, pages: [], pdfDoc: null };
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    fileData.pdfDoc = pdf;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        const viewport = page.getViewport({ scale: 0.5 });
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        
                        const title = await extractTitleFromPage(page, i);
                        fileData.pages.push({ pageNum: i, canvas: canvas, firstLine: title });
                    }
                    pdfFiles.push(fileData);
                } catch (error) {
                    console.error(`è™•ç†æª”æ¡ˆ "${file.name}" å¤±æ•—:`, error);
                    alert(`è™•ç†æª”æ¡ˆ "${file.name}" å¤±æ•—ï¼Œæª”æ¡ˆå¯èƒ½å·²ææ¯€ã€‚`);
                }
            }
            updateFileList();
            renderSourcePages();

            progress.textContent = 'âœ… æª”æ¡ˆè¼‰å…¥å®Œæˆï¼';
            progress.classList.add('success');
            setTimeout(() => {
                progress.classList.remove('active', 'success');
            }, 2000);
        }

        async function extractTitleFromPage(page, pageNum) {
            const textContent = await page.getTextContent();
            if (textContent.items.length === 0) {
                return `Page ${pageNum}`;
            }

            const items = textContent.items
                .map(item => ({
                    text: item.str.trim(),
                    y: item.transform[5],
                    x: item.transform[4],
                    height: item.height,
                }))
                .filter(item => item.text.length > 0)
                .sort((a, b) => b.y - a.y || a.x - b.x);

            const lines = [];
            if (items.length > 0) {
                let currentLine = [items[0]];
                for (let i = 1; i < items.length; i++) {
                    if (Math.abs(items[i].y - currentLine[0].y) < 5) {
                        currentLine.push(items[i]);
                    } else {
                        lines.push(currentLine.sort((a, b) => a.x - b.x));
                        currentLine = [items[i]];
                    }
                }
                lines.push(currentLine.sort((a, b) => a.x - b.x));
            }

            let title = `Page ${pageNum}`;
            if (lines.length > 0) {
                let titleLineText = lines[0].map(item => item.text).join(' ');
                
                if (lines.length > 1) {
                    const firstLineY = lines[0][0].y;
                    const firstLineHeight = lines[0][0].height;
                    const secondLineY = lines[1][0].y;
                    if (Math.abs(firstLineY - secondLineY) < firstLineHeight * 1.8) {
                        titleLineText += ' ' + lines[1].map(item => item.text).join(' ');
                    }
                }

                let cleanedTitle = titleLineText;

                // --- RULE 1: Preserve numbers followed by "å¹´åº¦" ---
                if (!/^\d+\s*å¹´åº¦/.test(cleanedTitle.trim())) {
                    cleanedTitle = cleanedTitle.replace(/^[\d\s.\-â€¢]+\s*/, '');
                }

                const stopChars = ['ä¸€ã€', 'äºŒã€', 'ï¼ˆä¸€ï¼‰', 'é™„è¨»', 'èªªæ˜ï¼š', 'ä¸­è¯æ°‘åœ‹'];
                for (const char of stopChars) {
                    const pos = cleanedTitle.indexOf(char);
                    if (pos !== -1) {
                        cleanedTitle = cleanedTitle.substring(0, pos).trim();
                    }
                }
                
                const specialKeywords = ["èªªæ˜", "è¡¨", "æƒ…å½¢"];
                let earliestIndex = -1;
                let keywordLength = 0;

                for (const keyword of specialKeywords) {
                    const currentIndex = cleanedTitle.indexOf(keyword);
                    if (currentIndex !== -1) {
                        if (earliestIndex === -1 || currentIndex < earliestIndex) {
                            earliestIndex = currentIndex;
                            keywordLength = keyword.length;
                        }
                    }
                }

                if (earliestIndex !== -1) {
                    cleanedTitle = cleanedTitle.substring(0, earliestIndex + keywordLength);
                }

                // --- RULE 2: Remove ALL spaces from the final title ---
                cleanedTitle = cleanedTitle.replace(/\s+/g, '');

                if (cleanedTitle.length > 70) {
                    cleanedTitle = cleanedTitle.substring(0, 70) + '...';
                }

                if (cleanedTitle) {
                    title = cleanedTitle;
                }
            }
            return title;
        }

        function updateFileList() {
            fileList.innerHTML = pdfFiles.map((file, index) => `
                <li class="file-list-item">
                    <span>${file.name}</span>
                    <button class="btn btn-danger" onclick="removeFile(${index})">âœ•</button>
                </li>
            `).join('');
        }

        function removeFile(index) {
            pdfFiles.splice(index, 1);
            selectedPages = selectedPages.filter(p => p.fileIndex !== index).map(p => {
                if (p.fileIndex > index) p.fileIndex--;
                return p;
            });
            updateFileList();
            renderSourcePages();
            renderSelectedPages();
        }

        function clearAllFiles() {
            if (pdfFiles.length === 0) return;
            const clearBtn = document.getElementById('clearFilesBtn');
            if (!clearFilesConfirmMode) {
                clearFilesConfirmMode = true;
                clearBtn.classList.add('confirm-mode');
                clearBtn.innerHTML = 'ğŸ—‘ï¸ ç¢ºå®šæ¸…é™¤æ‰€æœ‰æª”æ¡ˆï¼Ÿ';
                setTimeout(() => {
                    clearFilesConfirmMode = false;
                    clearBtn.classList.remove('confirm-mode');
                    clearBtn.innerHTML = 'ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æª”æ¡ˆ';
                }, 3000);
                return;
            }
            pdfFiles = [];
            selectedPages = [];
            lastSelectedIndex = null;
            clearFilesConfirmMode = false;
            fileInput.value = '';
            clearBtn.classList.remove('confirm-mode');
            clearBtn.innerHTML = 'ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æª”æ¡ˆ';
            updateFileList();
            renderSourcePages();
            renderSelectedPages();
        }

        function setViewMode(mode) {
            viewMode = mode;
            document.getElementById('gridViewBtn').classList.toggle('active', mode === 'grid');
            document.getElementById('listViewBtn').classList.toggle('active', mode === 'list');
            renderSourcePages();
        }

        function setThumbnailSize(size) {
            thumbnailSize = size;
            sourcePanel.classList.remove('size-small', 'size-medium', 'size-large', 'size-xlarge');
            sourcePanel.classList.add(`size-${size}`);
            
            document.querySelectorAll('#size-toggle button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#size-toggle button[onclick="setThumbnailSize('${size}')"]`).classList.add('active');
        }

        function toggleSourceEditMode() {
            isSourceEditMode = !isSourceEditMode;
            const btn = document.getElementById('editSourceBtn');
            sourcePanel.classList.toggle('edit-mode', isSourceEditMode);
            btn.classList.toggle('active', isSourceEditMode);
            btn.innerHTML = isSourceEditMode ? 'âœ“ å®Œæˆ' : 'ğŸ—‘ï¸ åˆªé™¤é é¢';
            renderSourcePages();
        }

        function deleteSourcePage(fileIndex, pageIndex) {
            const pageToDelete = pdfFiles[fileIndex].pages[pageIndex];
            selectedPages = selectedPages.filter(p => !(p.type !== 'divider' && p.fileIndex === fileIndex && p.pageNum === pageToDelete.pageNum));
            pdfFiles[fileIndex].pages.splice(pageIndex, 1);
            if (pdfFiles[fileIndex].pages.length === 0) {
                removeFile(fileIndex);
            } else {
                renderSourcePages();
                renderSelectedPages();
            }
        }

        function renderSourcePages() {
            if (pdfFiles.length === 0) {
                sourcePages.innerHTML = '<div class="empty-message">å°šæœªè¼‰å…¥ä»»ä½• PDF æª”æ¡ˆ</div>';
                return;
            }
            sourcePages.innerHTML = pdfFiles.map((file, fileIndex) => {
                const pagesHtml = viewMode === 'grid' 
                    ? `<div class="pages-grid">${file.pages.map((page, pageIndex) => renderPageItem(fileIndex, pageIndex, 'grid')).join('')}</div>`
                    : `<div class="pages-list">${file.pages.map((page, pageIndex) => renderPageItem(fileIndex, pageIndex, 'list')).join('')}</div>`;
                return `<div class="pdf-file"><div class="pdf-file-header"><div class="pdf-file-name">${file.name}</div></div>${pagesHtml}</div>`;
            }).join('');
            pdfFiles.forEach((file, fileIndex) => {
                file.pages.forEach((page, pageIndex) => {
                    const canvas = document.getElementById(`source_${fileIndex}_${pageIndex}`);
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        canvas.width = page.canvas.width;
                        canvas.height = page.canvas.height;
                        ctx.drawImage(page.canvas, 0, 0);
                    }
                });
            });
        }

        function renderPageItem(fileIndex, pageIndex, type) {
            const page = pdfFiles[fileIndex].pages[pageIndex];
            const isSelected = selectedPages.some(p => p.type !== 'divider' && p.fileIndex === fileIndex && p.pageNum === page.pageNum);
            const clickAction = isSourceEditMode ? '' : `onclick="togglePage(${fileIndex}, ${pageIndex}, event)"`;
            
            if (type === 'grid') {
                return `
                    <div class="page-item ${isSelected ? 'selected' : ''}" ${clickAction}>
                        <button class="delete-btn" onclick="deleteSourcePage(${fileIndex}, ${pageIndex})">âœ•</button>
                        <canvas id="source_${fileIndex}_${pageIndex}"></canvas>
                        <div class="page-number">ç¬¬ ${page.pageNum} é </div>
                    </div>`;
            } else { // list
                return `
                    <div class="page-list-item ${isSelected ? 'selected' : ''}" ${clickAction} title="${page.firstLine}">
                        <div class="page-list-text">${page.firstLine}</div>
                        <div class="page-list-number">ç¬¬ ${page.pageNum} é </div>
                        <button class="delete-btn" onclick="deleteSourcePage(${fileIndex}, ${pageIndex})">åˆªé™¤</button>
                    </div>`;
            }
        }

        function getGlobalPageIndex(fileIndex, pageIndex) {
            return pdfFiles.slice(0, fileIndex).reduce((acc, file) => acc + file.pages.length, 0) + pageIndex;
        }

        function getPageByGlobalIndex(globalIndex) {
            let count = 0;
            for (let fileIndex = 0; fileIndex < pdfFiles.length; fileIndex++) {
                const file = pdfFiles[fileIndex];
                if (globalIndex < count + file.pages.length) {
                    return { fileIndex, pageIndex: globalIndex - count };
                }
                count += file.pages.length;
            }
            return null;
        }

        function togglePage(fileIndex, pageIndex, event) {
            if (isSourceEditMode) return;
            const currentGlobalIndex = getGlobalPageIndex(fileIndex, pageIndex);
            if (event && event.shiftKey && lastSelectedIndex !== null) {
                const start = Math.min(lastSelectedIndex, currentGlobalIndex);
                const end = Math.max(lastSelectedIndex, currentGlobalIndex);
                for (let i = start; i <= end; i++) {
                    const pos = getPageByGlobalIndex(i);
                    if (pos) {
                        const f = pdfFiles[pos.fileIndex];
                        const p = f.pages[pos.pageIndex];
                        if (!selectedPages.some(sp => sp.type !== 'divider' && sp.fileIndex === pos.fileIndex && sp.pageNum === p.pageNum)) {
                            selectedPages.push({ type: 'page', fileIndex: pos.fileIndex, pageNum: p.pageNum, fileName: f.name, canvas: p.canvas, firstLine: p.firstLine });
                        }
                    }
                }
            } else {
                const existingIndex = selectedPages.findIndex(p => p.type !== 'divider' && p.fileIndex === fileIndex && p.pageNum === pdfFiles[fileIndex].pages[pageIndex].pageNum);
                if (existingIndex >= 0) {
                    selectedPages.splice(existingIndex, 1);
                } else {
                    const file = pdfFiles[fileIndex];
                    const page = file.pages[pageIndex];
                    selectedPages.push({ type: 'page', fileIndex: fileIndex, pageNum: page.pageNum, fileName: file.name, canvas: page.canvas, firstLine: page.firstLine });
                }
            }
            lastSelectedIndex = currentGlobalIndex;
            renderSourcePages();
            renderSelectedPages();
        }

        function clearSelectedPages() {
            if (selectedPages.length === 0) return;
            const btn = document.getElementById('clearSelectedBtn');
            if (!clearSelectedConfirmMode) {
                clearSelectedConfirmMode = true;
                btn.classList.add('confirm-mode');
                btn.textContent = 'ç¢ºå®šæ¸…é™¤ï¼Ÿ';
                setTimeout(() => {
                    clearSelectedConfirmMode = false;
                    btn.classList.remove('confirm-mode');
                    btn.textContent = 'ğŸ—‘ï¸ æ¸…é™¤é¸å–';
                }, 3000);
                return;
            }
            selectedPages = [];
            clearSelectedConfirmMode = false;
            btn.classList.remove('confirm-mode');
            btn.textContent = 'ğŸ—‘ï¸ æ¸…é™¤é¸å–';
            renderSourcePages();
            renderSelectedPages();
        }

        function addSectionDivider() {
            const title = prompt("è«‹è¼¸å…¥å°ç¯€æ¨™é¡Œï¼š");
            if (title && title.trim()) {
                selectedPages.push({
                    type: 'divider',
                    firstLine: title.trim(),
                    id: Date.now() // Unique ID for key
                });
                renderSelectedPages();
            }
        }

        function renderSelectedPages() {
            if (selectedPages.length === 0) {
                selectedPagesContainer.innerHTML = '<div class="empty-message">å°šæœªé¸æ“‡ä»»ä½•é é¢</div>';
                return;
            }
            selectedPagesContainer.innerHTML = selectedPages.map((item, index) => {
                if (item.type === 'divider') {
                    return `
                        <div class="selected-divider-item" draggable="true" data-index="${index}">
                            <span class="drag-handle">â‹®â‹®</span>
                            <div class="selected-divider-title">${item.firstLine}</div>
                            <div class="page-actions">
                                <button class="btn btn-danger" onclick="removeSelectedPage(${index})">âœ•</button>
                            </div>
                        </div>
                    `;
                }
                // Default is a page item
                return `
                    <div class="selected-page-item" draggable="true" data-index="${index}">
                        <span class="drag-handle">â‹®â‹®</span>
                        <canvas id="selected_${index}"></canvas>
                        <div class="selected-page-info">
                            <div class="selected-page-title">${item.firstLine}</div>
                            <div class="selected-page-source">${item.fileName} - ç¬¬ ${item.pageNum} é </div>
                        </div>
                        <div class="page-actions">
                            <button class="btn btn-danger" onclick="removeSelectedPage(${index})">âœ•</button>
                        </div>
                    </div>
                `;
            }).join('');

            selectedPages.forEach((item, index) => {
                if (item.type !== 'divider') {
                    const canvas = document.getElementById(`selected_${index}`);
                    const ctx = canvas.getContext('2d');
                    canvas.width = item.canvas.width;
                    canvas.height = item.canvas.height;
                    ctx.drawImage(item.canvas, 0, 0);
                }
            });
            setupDragAndDrop();
        }

        function removeSelectedPage(index) {
            selectedPages.splice(index, 1);
            renderSourcePages();
            renderSelectedPages();
        }

        function setupDragAndDrop() {
            document.querySelectorAll('.selected-page-item, .selected-divider-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedElement = item;
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });
                item.addEventListener('dragend', () => item.classList.remove('dragging'));
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(selectedPagesContainer, e.clientY);
                    if (afterElement == null) {
                        selectedPagesContainer.appendChild(draggedElement);
                    } else {
                        selectedPagesContainer.insertBefore(draggedElement, afterElement);
                    }
                });
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const fromIndex = parseInt(draggedElement.dataset.index);
                    const toIndex = Array.from(selectedPagesContainer.children).indexOf(draggedElement);
                    const [movedItem] = selectedPages.splice(fromIndex, 1);
                    selectedPages.splice(toIndex, 0, movedItem);
                    renderSelectedPages();
                });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.selected-page-item:not(.dragging), .selected-divider-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function openTocEditor() {
            const pageItems = selectedPages.filter(p => p.type !== 'divider');
            if (pageItems.length === 0) {
                alert('è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å€‹é é¢æ‰èƒ½ç·¨è¼¯ç›®éŒ„ã€‚');
                return;
            }
            const titles = pageItems.map(p => p.firstLine).join('\n');
            tocTextarea.value = titles;
            tocModal.style.display = 'flex';
        }

        function closeTocEditor() {
            tocModal.style.display = 'none';
        }

        function saveToc() {
            const newTitles = tocTextarea.value.split('\n');
            const pageItems = selectedPages.filter(p => p.type !== 'divider');
            if (newTitles.length !== pageItems.length) {
                alert(`éŒ¯èª¤ï¼šç›®éŒ„è¡Œæ•¸ (${newTitles.length}) èˆ‡é¸æ“‡çš„é æ•¸ (${pageItems.length}) ä¸ç¬¦ï¼Œè«‹æª¢æŸ¥å¾Œå†å„²å­˜ã€‚`);
                return;
            }
            let titleIndex = 0;
            selectedPages.forEach(item => {
                if (item.type !== 'divider') {
                    item.firstLine = newTitles[titleIndex];
                    titleIndex++;
                }
            });
            renderSelectedPages();
            closeTocEditor();
        }

        async function generatePDF() {
            const pageItems = selectedPages.filter(p => p.type !== 'divider');
            if (pageItems.length === 0) {
                progress.textContent = 'âš ï¸ è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é é¢';
                progress.classList.add('active', 'error');
                setTimeout(() => progress.classList.remove('active', 'error'), 3000);
                return;
            }
            try {
                progress.textContent = 'â³ æ­£åœ¨æº–å‚™ç”Ÿæˆ PDF...';
                progress.classList.remove('success', 'error');
                progress.classList.add('active');
                
                const { PDFDocument, rgb, StandardFonts } = PDFLib;
                const newPdf = await PDFDocument.create();
                let customFont;

                try {
                    progress.textContent = 'æ­£åœ¨ä¸‹è¼‰ä¸­æ–‡å­—å‹...';
                    const fontUrl = './fonts/NotoSansTC-Regular.ttf';
                    const fontBytes = await fetch(fontUrl).then(res => res.arrayBuffer());
                    newPdf.registerFontkit(fontkit);
                    customFont = await newPdf.embedFont(fontBytes);
                } catch (fontError) {
                    console.error("ä¸­æ–‡å­—å‹è¼‰å…¥å¤±æ•—:", fontError);
                    alert("è­¦å‘Šï¼šä¸­æ–‡å­—å‹ä¸‹è¼‰å¤±æ•—ï¼Œç›®éŒ„å°‡ä½¿ç”¨è‹±æ–‡å­—å‹é¡¯ç¤ºï¼ˆä¸­æ–‡æœƒè®Šäº‚ç¢¼ï¼‰ã€‚");
                    customFont = await newPdf.embedFont(StandardFonts.Helvetica);
                }
                
                progress.textContent = 'æ­£åœ¨å»ºç«‹ç›®éŒ„é ...';
                const tocPage = newPdf.addPage([842, 595]);
                tocPage.drawText('ç›®éŒ„', { x: 50, y: 595 - 50, size: 18, font: customFont, color: rgb(0,0,0) });
                let yPosition = 595 - 90;
                let pageCounter = 0;

                selectedPages.forEach(item => {
                    if (item.type === 'divider') {
                        yPosition -= 10;
                        tocPage.drawText(item.firstLine, { x: 50, y: yPosition, size: 14, font: customFont, color: rgb(0,0,0) });
                        yPosition -= 25;
                    } else {
                        pageCounter++;
                        const title = item.firstLine;
                        const text = `${pageCounter}. ${title.substring(0, 35)} ............ Page ${pageCounter}`;
                        tocPage.drawText(text, { x: 70, y: yPosition, size: 12, font: customFont, color: rgb(0,0,0) });
                        yPosition -= 20;
                    }
                });

                pageCounter = 0;
                for (const item of selectedPages) {
                    if (item.type === 'divider') continue;

                    pageCounter++;
                    progress.textContent = `æ­£åœ¨åˆä½µé é¢ (${pageCounter}/${pageItems.length})...`;
                    
                    const sourceFile = pdfFiles[item.fileIndex];
                    const freshArrayBuffer = await sourceFile.file.arrayBuffer();
                    const sourcePdf = await PDFDocument.load(freshArrayBuffer);
                    const [copiedPage] = await newPdf.copyPages(sourcePdf, [item.pageNum - 1]);
                    newPdf.addPage(copiedPage);
                    
                    const newPageNumber = `${pageCounter}`;
                    const { width, height } = copiedPage.getSize();
                    copiedPage.drawText(newPageNumber, {
                        x: width - 40,
                        y: 30,
                        size: 10,
                        font: customFont,
                        color: rgb(0, 0, 0)
                    });
                }

                progress.textContent = 'æ­£åœ¨å„²å­˜ PDF...';
                const pdfBytes = await newPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'é‡çµ„å¾Œçš„PDF_' + new Date().toISOString().slice(0, 10) + '.pdf';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 1000);

                progress.textContent = 'âœ… PDF ç”ŸæˆæˆåŠŸï¼';
                progress.classList.add('success');
                setTimeout(() => progress.classList.remove('active', 'success'), 5000);
            } catch (error) {
                progress.textContent = 'âŒ ç”Ÿæˆå¤±æ•—ï¼š' + error.message;
                progress.classList.add('active', 'error');
                console.error('ç”Ÿæˆ PDF æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setThumbnailSize('medium');
            tocModal.addEventListener('click', (e) => {
                if (e.target === tocModal) {
                    closeTocEditor();
                }
            });
        });
    </script>
</body>
</html>
