<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 重組工具 - 專案說明文件</title>
    <style>
        /* --- 整體頁面樣式 --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #f4f7f9;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        h1, h2, h3 {
            color: #1a253c;
            border-bottom: 2px solid #eef2f5;
            padding-bottom: 10px;
        }

        /* --- 頁籤樣式 --- */
        .tab-buttons {
            overflow: hidden;
            background-color: #f1f1f1;
            border-bottom: 1px solid #ccc;
        }

        .tab-buttons button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 20px;
            transition: background-color 0.3s;
            font-size: 16px;
            font-weight: 500;
        }

        .tab-buttons button:hover {
            background-color: #ddd;
        }

        .tab-buttons button.active {
            background-color: #2c3e50;
            color: white;
        }

        /* --- 頁籤內容樣式 --- */
        .tab-content {
            padding: 20px 30px;
            border-top: none;
        }

        .tab {
            display: none; /* 預設隱藏 */
        }
        
        /* --- 程式碼區塊樣式 --- */
        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 6px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        code {
            font-family: "Fira Code", "Consolas", "Monaco", monospace;
            font-size: 14px;
        }
        
        /* --- 清單與說明樣式 --- */
        ul, ol {
            padding-left: 20px;
        }
        
        li {
            margin-bottom: 10px;
        }

        strong {
            color: #c0392b;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1 style="text-align: center; padding: 20px; margin: 0; background-color: #2c3e50; color: white;">PDF 頁面重組工具 - 專案文件</h1>

        <!-- 頁籤按鈕 -->
        <div class="tab-buttons">
            <button class="tab-button" onclick="openTab(event, 'requirements')" id="defaultOpen">開發需求</button>
            <button class="tab-button" onclick="openTab(event, 'code')">程式碼含註解</button>
            <button class="tab-button" onclick="openTab(event, 'manual')">使用說明</button>
        </div>

        <!-- 頁籤內容 -->
        <div class="tab-content">
            <!-- 開發需求 Tab -->
            <div id="requirements" class="tab">
                <h2>專案目的</h2>
                <p>
                    此工具旨在解決使用者需要合併多個 PDF 檔案、重組頁面順序、並生成包含專業目錄的單一 PDF 檔案的需求。傳統方法通常需要使用昂貴的商業軟體且操作繁瑣，本工具透過瀏覽器客戶端技術，提供一個直觀、高效且無需安裝的解決方案。
                </p>

                <h2>主要功能</h2>
                <ul>
                    <li><strong>多檔案上傳：</strong>支援透過拖曳或檔案選擇器一次上傳多個 PDF 檔案。</li>
                    <li><strong>頁面視覺化：</strong>以縮圖或清單模式預覽所有來源 PDF 的頁面。</li>
                    <li><strong>彈性頁面選取：</strong>支援單點選取、按住 <code>Shift</code> 鍵進行範圍選取。</li>
                    <li><strong>直觀排序：</strong>在「已選擇的頁面」面板中，透過拖曳自由調整頁面與章節的順序。</li>
                    <li><strong>章節分隔：</strong>可新增自訂標題的「小節」，讓產出的目錄更具結構性。</li>
                    <li><strong>目錄自動生成：</strong>可選擇在最終 PDF 的第一頁自動生成專業的目錄頁，包含頁碼對應。</li>
                    <li><strong>批次編輯目錄：</strong>提供文字編輯器，可一次性修改所有選定頁面在目錄中顯示的標題。</li>
                    <li><strong>來源頁面管理：</strong>提供刪除模式，可從來源面板中移除不需要的頁面。</li>
                    <li><strong>純客戶端運作：</strong>所有操作均在使用者瀏覽器中完成，確保檔案的隱私與安全，無需上傳至伺服器。</li>
                    <li><strong>保留文字內容：</strong>生成的 PDF 保留原始文字，支援搜尋與複製。</li>
                    <li><strong>中文字型支援：</strong>內嵌「思源黑體」字型，確保目錄中的中文能正確顯示。</li>
                </ul>
                
                <h2>技術棧</h2>
                <ul>
                    <li><strong>前端框架：</strong>原生 HTML, CSS, JavaScript，無任何外部框架，確保輕量與高效。</li>
                    <li><strong>PDF 渲染：</strong>使用 Mozilla 的 <strong>pdf.js</strong> 函式庫，負責讀取 PDF 檔案並將頁面渲染成 Canvas 圖像以供預覽。</li>
                    <li><strong>PDF 生成與編輯：</strong>使用 <strong>pdf-lib.js</strong> 函式庫，負責建立新的 PDF 文件、複製來源頁面、新增目錄頁與頁碼等核心功能。</li>
                    <li><strong>字型處理：</strong>使用 <strong>fontkit</strong>，配合 pdf-lib.js 來註冊並嵌入自訂的 OTF/TTF 字型檔。</li>
                    <li><s><strong>PDF 加密：</strong></s> <s>原使用 pdf-encryptor 函式庫提供 AES-256 加密功能，<strong>已根據需求移除</strong>。</s></li>
                </ul>
                
                <h2>專案結構</h2>
                <p>要運行此專案，您需要以下檔案結構：</p>
                <pre><code>/
|-- index.html         (主 HTML 檔案)
|-- style.css          (CSS 樣式表)
|-- script.js          (主要的 JavaScript 邏輯)
|-- NotoSansTC-Regular.otf (思源黑體字型檔，用於目錄)
|-- pdf.min.js         (pdf.js 函式庫主檔案)
|-- pdf.worker.min.js  (pdf.js 的 Web Worker)
</code></pre>
            </div>

            <!-- 程式碼 Tab -->
            <div id="code" class="tab">
                <h2>程式碼總覽</h2>
                <p>以下是構成此工具的完整程式碼，包含詳細註解。</p>
                
                <h3>HTML (index.html)</h3>
                <pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang="zh-TW"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;PDF 頁面重組工具 (專業目錄版)&lt;/title&gt;
    
    &lt;!-- 引用 pdf.js 函式庫，用於讀取和渲染 PDF 預覽 --&gt;
    &lt;script src="./pdf.min.js"&gt;&lt;/script&gt; 
    
    &lt;!-- 引用 pdf-lib 函式庫，用於建立和修改 PDF 文件 --&gt;
    &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"&gt;&lt;/script&gt;
    &lt;!-- 引用 fontkit，配合 pdf-lib 嵌入中文字型 --&gt;
    &lt;script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"&gt;&lt;/script&gt;

    &lt;link rel="stylesheet" href="style.css"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;!-- 側邊欄：控制區域 --&gt;
    &lt;div class="sidebar"&gt;
        &lt;h2&gt;📄 PDF 頁面重組工具&lt;/h2&gt;
        
        &lt;!-- 檔案上傳區 --&gt;
        &lt;div class="upload-area" id="uploadArea"&gt;
            &lt;p style="margin-bottom: 10px;"&gt;📁 拖曳 PDF 檔案到這裡&lt;/p&gt;
            &lt;p style="font-size: 12px; color: #bdc3c7; margin-bottom: 15px;"&gt;或&lt;/p&gt;
            &lt;button class="btn btn-primary" onclick="document.getElementById('fileInput').click()"&gt;
                選擇檔案
            &lt;/button&gt;
            &lt;input type="file" id="fileInput" accept="application/pdf" multiple&gt;
        &lt;/div&gt;

        &lt;!-- 已載入檔案清單 --&gt;
        &lt;div&gt;
            &lt;h2&gt;已載入檔案&lt;/h2&gt;
            &lt;ul class="file-list" id="fileList"&gt;&lt;/ul&gt;
            &lt;button class="btn btn-warning" id="clearFilesBtn" onclick="clearAllFiles()" style="margin-top: 10px;"&gt;
                🗑️ 清除所有檔案
            &lt;/button&gt;
        &lt;/div&gt;

        &lt;!-- 提示訊息 --&gt;
        &lt;div class="note"&gt;
            💡 提示：生成的 PDF 會保留原始文字，可以正常搜尋和複製。目錄使用思源黑體以支援中文顯示。
        &lt;/div&gt;

        &lt;!-- 進度條 --&gt;
        &lt;div class="progress" id="progress"&gt;
            &lt;div&gt;正在生成 PDF...&lt;/div&gt;
        &lt;/div&gt;

        &lt;!-- 生成選項 --&gt;
        &lt;div class="options-group"&gt;
            &lt;div&gt;
                &lt;input type="checkbox" id="addTocCheckbox" checked&gt;
                &lt;label for="addTocCheckbox"&gt;新增目錄頁 (會放在第一頁)&lt;/label&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;!-- 主操作按鈕 --&gt;
        &lt;button class="btn btn-success" id="generateBtn" onclick="generatePDF()"&gt;
            生成新的 PDF
        &lt;/button&gt;
    &lt;/div&gt;

    &lt;!-- 主要內容區 --&gt;
    &lt;div class="main-content"&gt;
        &lt;!-- 來源 PDF 頁面面板 --&gt;
        &lt;div class="source-panel" id="sourcePanel"&gt;
            &lt;div class="panel-title"&gt;
                &lt;span&gt;📑 原始 PDF 頁面&lt;/span&gt;
                &lt;div class="panel-controls"&gt;
                    &lt;!-- 預覽大小切換 --&gt;
                    &lt;div class="toggle-group" id="size-toggle"&gt;
                        &lt;button onclick="setThumbnailSize('small')"&gt;小&lt;/button&gt;
                        &lt;button onclick="setThumbnailSize('medium')"&gt;中&lt;/button&gt;
                        &lt;button onclick="setThumbnailSize('large')"&gt;大&lt;/button&gt;
                        &lt;button onclick="setThumbnailSize('xlarge')"&gt;超大&lt;/button&gt;
                    &lt;/div&gt;
                    &lt;!-- 視圖模式切換 --&gt;
                    &lt;div class="toggle-group"&gt;
                        &lt;button id="gridViewBtn" class="active" onclick="setViewMode('grid')"&gt;縮圖&lt;/button&gt;
                        &lt;button id="listViewBtn" onclick="setViewMode('list')"&gt;清單&lt;/button&gt;
                    &lt;/div&gt;
                    &lt;!-- 刪除頁面模式按鈕 --&gt;
                    &lt;button id="editSourceBtn" class="btn-panel-action btn-edit" onclick="toggleSourceEditMode()"&gt;🗑️ 刪除頁面&lt;/button&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div id="sourcePages"&gt;&lt;/div&gt;
        &lt;/div&gt;

        &lt;!-- 已選擇頁面面板 --&gt;
        &lt;div class="target-panel"&gt;
            &lt;div class="panel-title"&gt;
                &lt;span&gt;📋 已選擇的頁面&lt;/span&gt;
                &lt;div class="panel-controls"&gt;
                    &lt;button class="btn-panel-action btn-add-section" onclick="addSectionDivider()"&gt;➕ 新增小節&lt;/button&gt;
                    &lt;button class="btn-panel-action btn-edit" onclick="openTocEditor()"&gt;✏️ 批次編輯目錄&lt;/button&gt;
                    &lt;button id="clearSelectedBtn" class="btn-panel-action btn-clear" onclick="clearSelectedPages()"&gt;🗑️ 清除選取&lt;/button&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="selected-pages" id="selectedPages"&gt;&lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- 目錄批次編輯彈窗 (Modal) --&gt;
    &lt;div class="modal-overlay" id="tocModal"&gt;
        &lt;div class="modal-content"&gt;
            &lt;h3&gt;批次編輯目錄&lt;/h3&gt;
            &lt;p style="font-size: 13px; color: #7f8c8d;"&gt;請在下方編輯目錄，一行代表一頁。完成後請確保總行數與選擇的頁數相同。&lt;/p&gt;
            &lt;textarea id="tocTextarea"&gt;&lt;/textarea&gt;
            &lt;div class="modal-actions"&gt;
                &lt;button class="btn" onclick="closeTocEditor()"&gt;取消&lt;/button&gt;
                &lt;button class="btn btn-primary" onclick="saveToc()"&gt;儲存變更&lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;script src="script.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

                <h3>CSS (style.css)</h3>
                <pre><code>/* --- 整體佈局 --- */
body {
    margin: 0;
    font-family: sans-serif;
    display: flex;
    height: 100vh;
    overflow: hidden;
    background-color: #ecf0f1;
}

.sidebar {
    width: 320px;
    background-color: #2c3e50;
    color: #ecf0f1;
    padding: 20px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

.main-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* --- 面板樣式 --- */
.source-panel, .target-panel {
    display: flex;
    flex-direction: column;
    background-color: #ffffff;
    border-bottom: 2px solid #e0e0e0;
}
.source-panel { flex: 1; overflow-y: auto; }
.target-panel { height: 40%; overflow-y: auto; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); }

.panel-title {
    background-color: #f8f9fa;
    padding: 10px 15px;
    font-weight: bold;
    color: #34495e;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 10;
}

.panel-controls { display: flex; align-items: center; gap: 10px; }

#sourcePages, .selected-pages { padding: 15px; }

/* --- 按鈕 --- */
.btn {
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s;
}
.btn-primary { background-color: #3498db; color: white; }
.btn-primary:hover { background-color: #2980b9; }
.btn-success { width: 100%; padding: 12px; font-size: 16px; background-color: #2ecc71; color: white; margin-top: auto; }
.btn-success:hover { background-color: #27ae60; }
.btn-warning { background-color: #f39c12; color: white; }
.btn-warning:hover { background-color: #e67e22; }
.btn-danger { background-color: #e74c3c; color: white; font-size: 12px; padding: 4px 8px;}
.btn-danger:hover { background-color: #c0392b; }

/* --- 上傳區域 --- */
.upload-area {
    border: 2px dashed #3498db;
    border-radius: 5px;
    padding: 20px;
    text-align: center;
    margin-bottom: 20px;
    background-color: #34495e;
}
.upload-area.drag-over { background-color: #4e6a85; }
#fileInput { display: none; }

/* --- 檔案列表 --- */
.file-list { list-style: none; padding: 0; }
.file-list-item { display: flex; justify-content: space-between; align-items: center; padding: 5px; background: #34495e; margin-bottom: 5px; border-radius: 3px;}

/* --- 來源頁面 (縮圖模式) --- */
.pages-grid { display: grid; gap: 15px; }
.size-small .pages-grid { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); }
.size-medium .pages-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
.size-large .pages-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
.size-xlarge .pages-grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }

.page-item {
    border: 2px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.2s;
}
.page-item:hover { border-color: #3498db; transform: translateY(-2px); }
.page-item.selected { border-color: #2ecc71; box-shadow: 0 0 10px rgba(46, 204, 113, 0.5); }
.page-item canvas { width: 100%; height: auto; display: block; }
.page-number {
    position: absolute;
    bottom: 0;
    right: 0;
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 2px 6px;
    font-size: 11px;
    border-top-left-radius: 4px;
}

/* --- 已選擇頁面 --- */
.selected-page-item, .selected-divider-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin-bottom: 8px;
    background: #f9f9f9;
}
.drag-handle { cursor: grab; margin-right: 10px; color: #95a5a6; }
.selected-page-item.dragging { opacity: 0.5; }

.selected-page-item canvas { width: 40px; height: auto; margin-right: 10px; border: 1px solid #ddd; }
.selected-page-info { flex-grow: 1; }
.selected-page-title { font-weight: bold; font-size: 14px; }
.selected-page-source { font-size: 12px; color: #7f8c8d; }

.selected-divider-title { font-weight: bold; color: #2980b9; flex-grow: 1; }

/* --- Modal 彈窗 --- */
.modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    display: none; /* Initially hidden */
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
.modal-content {
    background: white;
    padding: 30px;
    border-radius: 8px;
    width: 600px;
    max-width: 90%;
}
#tocTextarea { width: 100%; height: 400px; margin: 15px 0; font-family: monospace; }
.modal-actions { text-align: right; }
.modal-actions .btn { margin-left: 10px; }
</code></pre>
                
                <h3>JavaScript (script.js)</h3>
                <pre><code>// ==========================================================
// ===         *** 本地檔案 ***
// === 確保所有函式庫 (包含本地 pdf.min.js) 都載入後才執行
// ==========================================================
window.onload = function() {

    // --- 設定 workerSrc 指向本地檔案 ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.min.js';

    // --- 全域變數定義 ---
    let pdfFiles = []; // 儲存已載入的 PDF 檔案物件
    let selectedPages = []; // 儲存使用者選擇的頁面
    let draggedElement = null; // 用於拖曳排序
    let viewMode = 'grid'; // 'grid' 或 'list'
    let thumbnailSize = 'medium'; // 'small', 'medium', 'large', 'xlarge'
    let lastSelectedIndex = null; // 用於 Shift 連續選取
    let clearFilesConfirmMode = false; // 清除檔案的二次確認模式
    let clearSelectedConfirmMode = false; // 清除選取的二次確認模式
    let isSourceEditMode = false; // 是否處於來源頁面刪除模式

    // --- 檢查核心函式庫是否存在 ---
    if (typeof PDFLib === 'undefined') {
        console.error("CRITICAL: PDFLib is not defined when onload executes!");
        alert("錯誤：PDF 編輯函式庫 (pdf-lib.min.js) 載入失敗，請檢查網路連線。");
        return;
    }
     if (typeof fontkit === 'undefined') {
        console.error("CRITICAL: fontkit is not defined when onload executes!");
        alert("錯誤：字型工具函式庫 (fontkit.umd.min.js) 載入失敗，請檢查網路連線。");
        return; 
    }

    // --- 獲取 DOM 元素 ---
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const sourcePanel = document.getElementById('sourcePanel');
    const sourcePages = document.getElementById('sourcePages');
    const selectedPagesContainer = document.getElementById('selectedPages');
    const progress = document.getElementById('progress');
    const tocModal = document.getElementById('tocModal');
    const tocTextarea = document.getElementById('tocTextarea');
    const addTocCheckbox = document.getElementById('addTocCheckbox');

    // --- 事件監聽 ---
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('drag-over'); });
    uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('drag-over'); });
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
        handleFiles(files);
    });
    fileInput.addEventListener('change', (e) => { handleFiles(Array.from(e.target.files)); });

    /**
     * 處理上傳的 PDF 檔案
     * @param {File[]} files - 使用者選擇的檔案陣列
     */
    async function handleFiles(files) {
        if (files.length === 0) return;
        
        progress.textContent = `⏳ 正在載入 ${files.length} 個檔案...`;
        progress.classList.add('active');

        for (const file of files) {
            const fileData = { name: file.name, file: file, pages: [], pdfDoc: null };
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                fileData.pdfDoc = pdf;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    // 產生預覽圖
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    const viewport = page.getViewport({ scale: 0.5 });
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    
                    // 提取頁面標題
                    const title = await extractTitleFromPage(page, i);
                    fileData.pages.push({ pageNum: i, canvas: canvas, firstLine: title });
                }
                pdfFiles.push(fileData);
            } catch (error) {
                console.error(`處理檔案 "${file.name}" 失敗:`, error);
                alert(`處理檔案 "${file.name}" 失敗，檔案可能已損毀或函式庫載入不完整。`);
            }
        }
        updateFileList();
        renderSourcePages();

        progress.textContent = '✅ 檔案載入完成！';
        setTimeout(() => { progress.classList.remove('active'); }, 2000);
    }
    
    // ... 此處省略 extractTitleFromPage, updateFileList, removeFile, clearAllFiles, setViewMode, etc. 的完整程式碼，因為它們過於冗長。
    // 在真實的 script.js 檔案中，這些函式都包含在內。
    // 以下為最重要的生成 PDF 函式
    
    /**
     * 生成最終的 PDF 檔案
     */
    async function generatePDF() {
         if (typeof PDFLib === 'undefined' || typeof PDFLib.PDFDocument === 'undefined') {
            alert("錯誤：無法生成 PDF，編輯函式庫載入失敗。");
            return;
        }

        const { PDFDocument, rgb, StandardFonts } = PDFLib;
        const pageItems = selectedPages.filter(p => p && p.type !== 'divider');
        if (pageItems.length === 0) {
            alert('請至少選擇一個頁面');
            return;
        }

        try {
            progress.textContent = '⏳ 正在準備生成 PDF...';
            progress.classList.add('active');
            
            const newPdf = await PDFDocument.create();
            let customFont;

            // 載入中文字型
            try {
                progress.textContent = '正在載入中文字型...';
                const fontUrl = './NotoSansTC-Regular.otf';
                const fontBytes = await fetch(fontUrl).then(res => res.arrayBuffer());
                newPdf.registerFontkit(fontkit); 
                customFont = await newPdf.embedFont(fontBytes);
            } catch (fontError) {
                 alert(`警告：無法載入本地字型檔案。目錄將使用英文字型顯示（中文會變亂碼）。`);
                 customFont = await newPdf.embedFont(StandardFonts.Helvetica);
            }
            
            const addToc = addTocCheckbox.checked;
            let pageOffset = addToc ? 1 : 0; 

            // 如果需要，建立目錄頁
            if (addToc) {
                progress.textContent = '正在建立目錄頁...';
                // ... (此處是繪製目錄的詳細邏輯)
            }

            // 複製選擇的頁面到新 PDF
            let pageCounterForContent = 0;
            for (const item of selectedPages) {
                if (!item || item.type === 'divider') continue;
                pageCounterForContent++;
                progress.textContent = `正在合併頁面 (${pageCounterForContent}/${pageItems.length})...`;
                
                const sourceFile = pdfFiles[item.fileIndex];
                const freshArrayBuffer = await sourceFile.file.arrayBuffer();
                const sourcePdf = await PDFDocument.load(freshArrayBuffer, { ignoreEncryption: true });
                const [copiedPage] = await newPdf.copyPages(sourcePdf, [item.pageNum - 1]);
                newPdf.addPage(copiedPage);

                // 在新頁面底部加上頁碼
                const newPageNumber = `${pageCounterForContent + pageOffset}`;
                const { width, height } = copiedPage.getSize();
                copiedPage.drawText(newPageNumber, { x: width - 40, y: 30, size: 10, font: customFont, color: rgb(0, 0, 0) });
            }

            progress.textContent = '正在儲存 PDF...';
            
            // 生成 PDF 的二進位資料
            let pdfBytes = await newPdf.save();
            
            // --- 下載邏輯 ---
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const defaultFileName = '重組後的PDF_' + new Date().toISOString().slice(0, 10) + '.pdf';
            let finalFileName = prompt("請確認檔案名稱：", defaultFileName) || defaultFileName;
            a.download = finalFileName.endsWith('.pdf') ? finalFileName : finalFileName + '.pdf';
            a.click();
            URL.revokeObjectURL(url);

            progress.textContent = '✅ PDF 生成成功！';
            setTimeout(() => progress.classList.remove('active'), 5000);

        } catch (error) {
             console.error('生成 PDF 時發生錯誤：', error);
            progress.textContent = '❌ 生成失敗：' + error.message;
        }
    }
    
    // 將需要從 HTML onclick 呼叫的函式掛載到 window 物件上
    window.generatePDF = generatePDF;
    // ... 其他函式也需要掛載
};
</code></pre>
            </div>

            <!-- 使用說明 Tab -->
            <div id="manual" class="tab">
                <h2>操作指南</h2>
                <p>請依照以下步驟使用本工具，整個過程非常簡單直觀。</p>

                <ol>
                    <li>
                        <h3>第一步：載入 PDF 檔案</h3>
                        <p>您可以透過兩種方式載入檔案：</p>
                        <ul>
                            <li><strong>拖曳檔案：</strong>直接將一個或多個 PDF 檔案從您的電腦桌面或資料夾拖曳到左側標示有「📁 拖曳 PDF 檔案到這裡」的虛線框內。</li>
                            <li><strong>點擊按鈕：</strong>點擊「選擇檔案」按鈕，然後在跳出的視窗中選擇您想要處理的 PDF 檔案。</li>
                        </ul>
                        <p>載入的檔案會顯示在「已載入檔案」清單中，同時其所有頁面會顯示在右側的「原始 PDF 頁面」面板中。</p>
                    </li>

                    <li>
                        <h3>第二步：選擇需要的頁面</h3>
                        <p>在「原始 PDF 頁面」面板中，您可以選擇要包含在新 PDF 中的頁面：</p>
                        <ul>
                            <li><strong>單擊：</strong>點擊任何一個頁面縮圖即可選取它。已選取的頁面會出現綠色邊框。</li>
                            <li><strong>再次單擊：</strong>再次點擊已選取的頁面可以取消選取。</li>
                            <li><strong>範圍選取：</strong>先點擊一個頁面，然後按住鍵盤上的 <code>Shift</code> 鍵，再點擊另一個頁面，可以一次選取這兩個頁面之間的所有頁面。</li>
                        </ul>
                        <p>所有被選取的頁面會按照您點選的順序，出現在下方的「已選擇的頁面」面板中。</p>
                    </li>
                    
                    <li>
                        <h3>第三步：整理與排序頁面</h3>
                        <p>在「已選擇的頁面」面板中，您可以對頁面進行最終的整理：</p>
                        <ul>
                            <li><strong>拖曳排序：</strong>按住任何頁面左側的「⋮⋮」圖示，然後上下拖曳即可改變其順序。</li>
                            <li><strong>新增小節：</strong>點擊「➕ 新增小節」按鈕，輸入小節標題（例如：「第一章 合併資產負債表」），這會在目錄中建立一個章節標題，讓結構更清晰。小節本身也可以被拖曳排序。</li>
                            <li><strong>批次編輯目錄標題：</strong>點擊「✏️ 批次編輯目錄」按鈕，會彈出一個文字編輯器。您可以一次性修改所有頁面在目錄中顯示的標題，每一行對應一個頁面。</li>
                            <li><strong>移除頁面：</strong>點擊任一頁面右側的「✕」按鈕，可以將其從選取清單中移除。</li>
                        </ul>
                    </li>

                    <li>
                        <h3>第四步：生成最終的 PDF</h3>
                        <p>完成所有整理後，點擊左下角的綠色按鈕「<strong>生成新的 PDF</strong>」。</p>
                        <ul>
                            <li><strong>新增目錄頁：</strong>請確保「新增目錄頁」的選項是勾選的（預設為勾選），這樣生成的 PDF 第一頁纔會有目錄。</li>
                            <li><strong>命名檔案：</strong>點擊生成按鈕後，系統會彈出一個視窗讓您確認最終的檔案名稱。</li>
                        </ul>
                        <p>確認後，瀏覽器會開始處理並自動下載合併完成的 PDF 檔案。</p>
                    </li>
                </ol>

                <h3>其他功能</h3>
                <ul>
                    <li><strong>清除所有檔案：</strong>若要重新開始，可以點擊「🗑️ 清除所有檔案」按鈕（需要點擊兩次以確認）。</li>
                    <li><strong>刪除來源頁面：</strong>若某個來源檔案中有您完全不需要的頁面，可以點擊「原始 PDF 頁面」面板右上角的「🗑️ 刪除頁面」，此時面板會進入編輯模式，點擊頁面右上角的「✕」即可永久刪除該頁面。再次點擊「✓ 完成」可退出編輯模式。</li>
                </ul>
            </div>
        </div>

    </div>

    <script>
        /**
         * 頁籤切換邏輯
         * @param {Event} evt - 點擊事件
         * @param {string} tabName - 要顯示的頁籤 ID
         */
        function openTab(evt, tabName) {
            // 獲取所有頁籤內容並隱藏它們
            const tabContents = document.getElementsByClassName("tab");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].style.display = "none";
            }

            // 獲取所有頁籤按鈕並移除 "active" class
            const tabButtons = document.getElementsByClassName("tab-button");
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].className = tabButtons[i].className.replace(" active", "");
            }

            // 顯示當前點擊的頁籤內容，並為按鈕添加 "active" class
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // 預設打開第一個頁籤
        document.getElementById("defaultOpen").click();
    </script>

</body>
</html>
